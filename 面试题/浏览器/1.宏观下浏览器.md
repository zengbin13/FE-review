## TCP协议

- HTTP协议 与 WebSocket 协议都是基于TCP/IP的

- 数据是通过数据包来传输的，如果数据很大将会被拆分为很多小数据包传输

- **网际协议**（IP）

  - 将数据包传输到正确的地址
  - 数据包在传输前会被加上IP头用于正确寻址（**网络层**）
  - IP头包含：IP版本、源IP地址、目标IP地址、生存时间

- **用户数据包协议**（UDP）

  - 基于IP协议，通过**端口号**将指定的数据包发送给指定的程序
  - 在**传输层**包装UDP头，包含目标端口号等信息
  - UDP 可以校验数据是否正确，但对于发送错误的数据包**不提供重发机制**
  - UDP 在发送之后，不知道数据包是否抵达，也不知道如何组装大文件
  - **不能保证数据可靠性，但传输速度非常快**，可用于在线视频等场景

  > IP通过 IP 地址信息把数据包发送给指定的电脑
  >
  > UDP通过端口号把数据包分发给正确的程序

- **传输控制协议** (TCP )

  - **面向连接的、可靠的、基于字节流的传输层通信协议**
  - 对于要求数据传输可靠的场景，使用TCP协议
  - **重传机制**：引入数据包排序机制，用来保证把乱序的数据包组合成一个完整的文件
  - **数据包排序机制**：用来保证把乱序的数据包组合成一个完整的文件
  - TCP 头：包含端口号等，以及用于排序的序列号

- **TCP 连接过程**

  -  TCP 连接的生命周期包括**建立连接、传输数据、断开连接**

  <img src="C:\Users\Administrator\Desktop\zengBin\面试题\浏览器\宏观下浏览器.assets\image-20201126095311071.png" alt="image-20201126095311071" style="zoom:80%;" />

  - 建立连接：通过三次握手建立TCP连接
  - 传输数据：
    - 接收端需要对每个数据包进行确认，发送确认数据包给发送端
    - 在规定时间未收到确认反馈，触发重发机制
    - 数据包到达接收端，按照TCP头序号排序
  - 断开连接：四次挥手



##  HTTP请求流程

<img src="宏观下浏览器.assets/image-20201126105931705.png" alt="image-20201126105931705" style="zoom:80%;" />

- **HTTP协议允许浏览器向服务端获取资源**
- HTTP协议建立在连接的基础上
- HTTP内容通过TCP的传输数据阶段实现的

**浏览器发起HTTP请求流程**

- **构建请求**：输入URL地址，浏览器构建请求行信息
- **查找缓存**
  - 已缓存：拦截请求，返回资源副本
    - 缓解服务器压力，提升响应性能
  - 未缓存：进入网络请求过程
- **准备IP地址和端口**
  - 浏览器请求DNS返回域名对应IP 或浏览器**DNS缓存**服务
  - HTTP协议默认80端口
- **等待TCP连接**
  - 同一个域名同时最多只能建立 6 个 TCP 连接
- **建立TCP连接**：三次握手
- **发送HTTP请求**
  - 请求行：请求方法，请求URI，HTTP版本
  - GET：请求资源
  - POST：发送数据，保存在请求体
  - 请求头：浏览器基本信息、请求域名信息、cookie等



**服务器处理HTTP请求流程**

- **返回请求**
  - 响应行：HTTP版本、状态码
  - 响应头：返回数据时间，数据类型、需保存的Cookie等
  - 响应体：返回数据内容主体
- **断开连接**
  - 服务器返回请求数据，关闭TCP连接
  - `Connection:Keep-Alive`保持TCP长连接
  - 长连接提升资源加载速度，如内嵌图片来源于同一服务器



**浏览器缓存**

- 浏览器具有DNS缓存和页面资源缓存

  <img src="宏观下浏览器.assets/image-20201126105749981.png" alt="image-20201126105749981" style="zoom:80%;" />

- 浏览器通过响应头中的 **Cache-Control 字段**来设置是否缓存该资源

- 缓存未过期

  ```
  Cache-Control:Max-age=2000
  age:1000
  ```

- 缓存过期

  ```
  If-None-Match:"4f80f-13c-3a1xb12a"
  ```

  - 服务器收到请求头后，会根据 **If-None-Match字段** 判断请求的资源是否有更新

    

**登录状态保持**

- 用户提交登录信息，发送请求

- 服务端验证登录信息后，使用 **`Set-Cookie`字段**将token发送给浏览器

  ```
  Set-Cookie:UID = 3431uad
  ```

- 浏览器解析响应头保存cookie

- 用户再次访问该站点内容，携带cookie中信息

  ```
  Cookie: UID=3431uad
  ```

- 服务端验证tokon，判断是否已登录，返回页面数据

<img src="宏观下浏览器.assets/image-20201126105701597.png" alt="image-20201126105701597" style="zoom:67%;" />



## 导航流程

![image-20201126110158071](宏观下浏览器.assets/image-20201126110158071.png)

> 浏览器进程：负责用户交互、子进程管理、文件存储等
>
> 网络进程：面向渲染进程和浏览器进程等提供网络下载功能
>
> 渲染进程
>
> - 将资源解析为可显示交互的页面，运行在沙盒中
> - 包含排版引擎Blink和V8引擎
>
> 插件进程：插件，运行在沙盒中
>
> GPU进程： UI 界面绘制



**输入 URL 到页面展示（导航篇）**

1. **用户输入**

   - 搜索内容：使用默认搜索引擎，合成带关键字的URL
   - 请求URL：补全URL，开始导航
   - 浏览器进程：原页面未改变，标签栏显示加载动画

2. **URL请求**

   - 浏览器进程通过IPC将URL请求发送到网络进程
   - 网络进程查找本地缓存
   - 无缓存，进入网络请求流程：DNS解析获取IP -> HTTPS建立TLS连接 -> 建立TCP连接
   - 建立TCP连接后，**浏览器**构建请求信息携带Cookie发送请求 
   - **服务器**响应请求，网络进程解析响应头内容
     - 301 / 302 : 根据 **`Location`字段**URL再次导航
     - `Content-Type`字段：告知浏览器响应体数据类型

3. **准备渲染进程**

   - 非同一站点（根域名与协议相同），每个页面创建一个渲染进程
   - 浏览器进程准备渲染进程，此时不能进入文档解析状态

4. **提交文档**

   - 浏览器进程发出提交文档
   - 网络进程与渲染进程建立**传输响应数据的管道**
   - 文档数据传输完成，渲染进程返回信息
   - 浏览器进程更新标签栏状态

5. **渲染进程**

   - 文档提交后，渲染进程开始页面解析和子资源加载

   

##  渲染流程

1. **构建 DOM 树**

   - 将 HTML 解析为浏览器可以理解的 DOM树

2. **样式计算**

   - 将CSS文本转换为styleSheets
   - 标准化样式表中的属性值

   <img src="宏观下浏览器.assets/image-20201126141805876.png" alt="image-20201126141805876" style="zoom:80%;" />

   - 使用**继承规则和层叠规则**，计算出DOM树每个节点的具体样式生成样式树

3. **布局阶段**

   - 计算出DOM树中可见元素的几何位置
   - 创建布局树——**构建只包含可见元素布局树**

   <img src="宏观下浏览器.assets/image-20201126142258933.png" alt="image-20201126142258933" style="zoom: 67%;" />

   - 布局计算——计算布局树节点的坐标位置

4. **分层**

   - 渲染引擎为特定节点生成专用的图层，并构建对应图层树
   - 拥有层叠上下文属性或发生裁剪的元素单独提升一层

5. **图层绘制**

   -  为每个图层生成**绘制列表**，并将其提交到合成线程
   - 绘制列表由多个简单的绘制指令组成

6. **栅格化（raster）操作**

   - 绘制操作是由渲染引擎中的合成线程来完成
   - **合成线程会将图层划分为图块（tile）**
   - 合成线程按照视口附近的图块来优先生成位图，由栅格化来执行
   - 栅格化过程使用 GPU 来加速生成

   <img src="宏观下浏览器.assets/image-20201126143358123.png" alt="image-20201126143358123" style="zoom:80%;" />

7. **合成和显示**

   

